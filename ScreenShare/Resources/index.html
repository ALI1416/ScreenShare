<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>屏幕共享</title>
</head>
<body style="overflow:hidden">
<img
    id="img"
    src=""
    alt="网络连接异常，请刷新页面重试！"
    style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:none"
    ondblclick="end()"
>
<div id="div">
  <h1>屏幕共享</h1>
  <h2 id="info"></h2>
  <div id="online" style="display:none">
    <h2 id="screen"></h2>
    <button onclick="start(true)" style="font-size:30px;">点击开始</button>
    <h2>双击图像结束共享</h2>
  </div>
</div>
<script>
  let imgWidth;
  let imgHeight;
  let frame;
  let port;
  const img = document.getElementById("img");
  const div = document.getElementById("div");
  const info = document.getElementById("info");
  const screen = document.getElementById("screen");
  const online = document.getElementById("online");

  adjustImg();
  start(false);

  // 调整图片大小
  function adjustImg() {
    if (imgWidth / window.innerWidth < imgHeight / window.innerHeight) {
      img.style.height = "100%";
      img.style.width = null;
    } else {
      img.style.width = "100%";
      img.style.height = null;
    }
    screen.innerHTML = "当前屏幕尺寸&ensp;<code>" + window.innerWidth + "x" + window.innerHeight + "px</code>";
  }

  // 获取视频信息
  function start(open) {
    fetch("/api/getVideoInfo" + (port == 0 ? "?code=" + prompt("请输入密码") : ""))
        .then(resp => resp.json())
        .then(json => {
          imgWidth = json.width;
          imgHeight = json.height;
          frame = json.frame;
          port = json.port;
          online.style.display = "block";
          info.innerHTML = "远端视频尺寸&ensp;<code>" + imgWidth + "x" + imgHeight + "px</code>&emsp;每秒帧数&ensp;<code>" + frame + "FPS</code>";
          if (open) {
            if (port == 0) {
              alert("密码错误！");
            } else {
              img.src = "http://" + window.location.hostname + ":" + port;
              div.style.display = "none";
              img.style.display = "block";
            }
          }
        })
        .catch(() => {
          img.src = "";
          online.style.display = "none";
          info.innerHTML = "网络连接异常，请刷新页面重试！";
        })
  }

  // 结束
  function end() {
    img.src = "";
    img.style.display = "none";
    div.style.display = "block";
  }

  // 窗口大小发生变化时
  window.onresize = () => {
    adjustImg();
  };

</script>
</body>
</html>
